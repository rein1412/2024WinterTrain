# 电机控制系统仿真实验报告

<center><div style='height:2mm;'></div><div style="font-family:华文楷体;font-size:14pt;">张原   </div></center>
<center><span style="font-family:华文楷体;font-size:9pt">哈尔滨工程大学创梦之翼战队，电控组，邮箱:nicaibudaoba@qq,com<br /></span>

## 一、STM32 单片机配置

### 1、CubeMX 内核配置

![CubeMX 内核配置](屏幕截图%202024-01-14%20211033.png)
<font>选择SW烧写，防止芯片锁死</font>

![CubeMX 内核配置](屏幕截图%202024-01-14%20211905.png)
<font>选择外部高频晶振</font>

### 2、CubeMX 外设配置

<font>串口设置(开启接收中断)</font>
![CubeMX 串口设置](屏幕截图%202024-01-15%20191955.png)
<font>DMA设置</font>
![CubeMX 串口设置](屏幕截图%202024-01-15%20192622.png)

### 3、CubeMX 时钟配置

![CubeMX 时钟配置](屏幕截图%202024-01-14%20212126.png)
<font>芯片主频拉满72MHz</font>

## 二、嵌入式系统设计

### 1、嵌入式硬件拓扑图

![硬件拓扑图](屏幕截图%202024-01-15%20203639.png)

### 2、嵌入式软件框架

![软件流程图](屏幕截图%202024-01-15%20201859.png)

### 三、上位机通信程序设计

#### 1、串口发送

实现方法简述：

<font>在MXcube中配置好串口后，调用串口发送函数与上位机通信（阻塞发送）</font>

```c
uint8_t data[]="待发送内容";
int len=strlen(data);
HAL_UART_Transmit(&huart1, data, len,10); 
```

#### 2、串口接收

实现方法简述：

<font>在MXcube中配置好串口后，调用串口DMA中断接收函数与上位机通信（不定长接收）</font>

```C
uint8_t receive_data[500];
int len;

__HAL_UART_ENABLE_IT(&huart1, UART_IT_IDLE);
HAL_UART_Receive_DMA(&huart1, receive_data, 100);

void UART_IDLE_Callback(UART_HandleTypeDef *huart)
{
 if(__HAL_UART_GET_FLAG(huart,UART_FLAG_IDLE)) 
 {	
    __HAL_UART_CLEAR_IDLEFLAG(huart);
    __HAL_DMA_CLEAR_FLAG(huart,DMA_FLAG_TC5);
	HAL_UART_DMAStop(huart);
    int len=100-__HAL_DMA_GET_COUNTER(huart->hdmarx);
	HAL_UART_Transmit(&huart1, receive_data, len,10); 
    HAL_UART_Receive_DMA(&huart,receive_data,100);
 }
}


void USART1_IRQHandler(void)
{
    UART_IDLE_Callback(&huart1);
	return;
}
```

## 四、控制系统设计与实现

### <font color=Green>1、请思考是否可以建立该虚拟电机嵌入式控制系统的传递函数</font>

<font color=Blue>如果答案是可以的话，请描述建立传递函数的方法、自己的思路以及结果</font>

<font color=Blue>附上设计过程中重要的截图</font>

### 2、速度闭环

#### （1）系统框图

<font color=Blue>利用 drawio 绘制速度闭环反馈控制系统方框图，并写明设计思路</font>

#### <font color=Green>(2)若建立了传递函数，请使用它在matlab进行速度闭环仿真设计</font>

<font color=Blue>给出仿真设计simulink图片以及结果</font>

<font color=Blue>若使用了MATLAB语言请粘贴代码以及结果</font>

<font color=Blue>请进行简要说明</font>

#### （3）嵌入式系统关键代码

<font color=Blue>注意代码应使用代码块</font>

```C
//此处粘贴代码
```

### 3、角度闭环

#### （1）系统框图

##### a、单级反馈控制

<font color=Blue>利用 drawio 绘制角度闭环单级反馈控制系统方框图，并写明设计思路</font>

##### b、串级反馈控制

<font color=Blue>利用 drawio 绘制角度闭环串级反馈控制系统方框图，并写明设计思路</font>

#### <font color=Green>(2)若建立了传递函数，请使用它在matlab进行角度闭环仿真设计</font>

<font color=Blue>给出仿真设计simulink图片以及结果</font>

<font color=Blue>若使用了MATLAB语言请粘贴代码以及结果</font>

<font color=Blue>请进行简要说明</font>

#### （3）嵌入式系统关键代码

##### a、 单级反馈控制

```C
//此处粘贴代码
```

##### b、串级反馈控制

```C
//此处粘贴代码
```

### <font color=Green>4、复合控制</font>

#### <font color=Green>（1）复合控制系统框图与设计思路</font>

<font color=Blue>利用 drawio 绘制复合控制系统方框图，并写明设计思路</font>

#### <font color=Green>(2)若建立了传递函数，请使用它在matlab进行复合控制仿真设计</font>

<font color=Blue>给出仿真设计simulink图片以及结果</font>

<font color=Blue>若使用了MATLAB语言请粘贴代码以及结果</font>

<font color=Blue>请进行简要说明</font>

#### <font color=Green>（3）嵌入式复合控制系统关键代码</font>

<font color=Blue>注意代码应使用代码块</font>

```C
//此处粘贴代码
```

## 五、实验结论与分析

<font color=Blue>注：所有图片均需标明横纵坐标单位</font>

### 1、嵌入式速度闭环系统阶跃响应时域图

<font color=Blue>放一张图，应至少包含期望速度与速度闭环控制系统实际速度两条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### 2、嵌入式速度闭环系统频率响应时域图

<font color=Blue>放一张图，应至少包含期望速度与速度闭环控制系统实际速度两条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### 3、嵌入式角度闭环系统阶跃响应时域图

<font color=Blue>放一张图，应至少包含期望角度、单级角度闭环控制系统实际角度和串级角度闭环控制系统实际角度三条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### 4、嵌入式角度闭环系统阶频率时域图

<font color=Blue>放一张图，应至少包含期望角度、单级角度闭环控制系统实际角度和串级角度闭环控制系统实际角度三条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### 5、嵌入式角度闭环系统抗扰性能时域图

<font color=Blue>放一张图，应至少包含扰动输入、单级角度闭环控制系统和串级角度闭环控制系统控制器输出三条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### <font color=Green>6、嵌入式复合控制系统阶跃响应时域图</font>

<font color=Blue>放一张图，应至少包含期望角度与两种闭环控制系统（非复合控制、复合控制）实际角度三条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### <font color=Green>7、嵌入式复合控制系统频率响应时域图</font>

<font color=Blue>一张图，应至少包含期望角度与两种闭环控制系统（非复合控制、复合控制）实际角度三条曲线。并对比分析结果。</font>

<font color=Blue>进行简要说明。</font>

### <font color=Green> 8、嵌入式复合控制系统抗扰性能</font>

<font color=Blue>两张图：</font>

<font color=Blue>图 1 应至少包含扰动输入与两种闭环控制系统（非复合控制、复合控制）控制器输出三条曲线。并对比分析结果。</font>

<font color=Blue>图 2 应至少包含两种闭环控制（非复合控制、复合控制）系统实际角度两条曲线。</font>

<font color=Blue>进行简要说明。</font>

## 六、CAN通讯


### 1、简述CAN通讯协议原理、简述CAN通讯的优点。

![CAN通讯协议原理](23032dbab51c4fd6acee4cf0163d58e3.png)
<font>CAN用帧将数据发送给挂载在CAN总线的所有电机，再由对应ID电机接收。
CAN传输距离远，抗干扰性强，传输速度快，可以同时连接多个节点。</font>

### 2、简述CAN通讯的仲裁机制。

<font>每个设备有不同ID，接收时接收与ID相符的内容，发送时通过线与竞争总线，帧ID越小，优先级越高</font>

### 3、简述CAN通讯的过滤器的作用？以及如何使用HAL库进行配置？

<font>fifo通过列表模式和掩码模式筛选需要的帧,共有14组过滤器。<br />
以下为16位掩码模式CAN通信过滤器设置</font>
![16位掩码模式CAN过滤器设置](屏幕截图%202024-01-14%20231114.png)
<font>补：这部分没有完全被搞懂，还有其他方法配置过滤器，如下为RM官方例程的过滤器配置</font>
![16位掩码模式CAN过滤器设置](屏幕截图%202024-01-15%20171947.png)

### 4、简述CAN通讯波特率计算和如何使用CubeMX配置波特率。

![CAN通讯波特率计算](屏幕截图%202024-01-15%20144233.png)
![CAN通讯波特率计算](屏幕截图%202024-01-15%20143850.png)
<font>以上理论部分借用一个看过的视频里的说明<br />
波特率一般用满1M/s<br />
f103APB时钟频率为36MHz<br />
即要满足36=Tq（BS1+BS2+1）<br />
同时1+BS1=3BS2<br />
故设定如下
![CAN通讯波特率计算](屏幕截图%202024-01-15%20154055.png)
</font>

### 5、HAL库中CAN通讯初始化中有哪些必备的配置？

![CAN通讯初始化配置](屏幕截图%202024-01-15%20154653.png)
<font>如图配置并记得打开CAN接收中断</font>

### 6、CAN接收FIFO的作用？以及HAL库中相对应的回调函数应该如何使用？

<font>FIFO相当于两个邮箱，分别叫fifo0和fifo1，暂存CAN设备发来的报文</font>

```C
void HAL_CAN_RxFifo0MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
	CAN_RxHeaderTypeDef rx_header;
	
	HAL_CAN_GetRxMessage
	(hcan,CAN_RX_FIFO0,&rx_header,rx_data);
	if(hcan==&hcan1)
	{
	 if(rx_header.StdId==0x201)
	 {
		 motor_speed=(uint16_t)((rx_data)[2]<<8|(rx_data)[3]);
	 }
	}
}
```
<font>以上为用HAL_CAN_RxFifo0MsgPendingCallback函数从fifo0读取id0x201电机的转速的示例</font>

### <font color=Green>7、什么情况会导致CAN阻塞？</font>

<font>CAN相当于只有三个发送信箱和两个接收信箱，同时发出/接收报文个数超过此数可能就会导致阻塞</font>

### <font color=Green>8、简述CAN ID的意义和作用？CAN ID与优先级的关系?</font>

<font>因为CAN设备同时挂载在两条CAN总线上，所以不同设备必须有各自的ID对通信发送方及对象进行区分。<br />
CAN设备发送报文时，通过线与竞争总线，ID越小，优先级越高。</font>

### 9、请自行阅读《RoboMaster C620无刷电机调速器使用说明》回答下列问题

#### （1）我们能从C620电调反馈的报文中获取电机的哪些信息？单位是什么？怎么把主控板获取到的原始数据转换成我们想要的数据？机械转子角度和我们平时使用的角度单位有什么区别？

![](屏幕截图%202024-01-15%20162949.png)
<font >能获取的电机的信息，单位如图<br />

接收到报文后，通过将数据高八位和低八位拼接即可转换成我们想要的数据。例如</font>
`motor_speed=rx_data[2]<<8|rx_data[3];`<br />

<font >机械转子角度即为（数据/8191）*360</font>

#### （2）C620电调接收的控制指令代表什么含义？

![无需多言](屏幕截图%202024-01-15%20164104.png)

<font>如图，代表-20~20A的电流</font>

#### （3）C620电调接收和反馈的报文的CAN标识符是什么？分别代表什么含义？在HAL库里分别对应什么？

<font>如上图，接收标识符为0x200或0x1FF，分别代表ID为1234，5678的电调<br />反馈标识符为0x200+电调ID<br />
在HAL库里分别对应Txheader2.StdId和rx_header.StdId</font>

### <font color=Green>10、请给出你写的基于HAL库的CAN通讯初始化函数、和C620电调通讯的主控板CAN发送和CAN接收的函数。</font>

<font>如图，以控制ID为1的电调为例</font>

```C
void can_filter_init(void)
{
    CAN_FilterTypeDef can_filter_st;
    can_filter_st.FilterActivation = ENABLE;
    can_filter_st.FilterMode = CAN_FILTERMODE_IDMASK;
    can_filter_st.FilterScale = CAN_FILTERSCALE_32BIT;
    can_filter_st.FilterIdHigh = 0x0000;
    can_filter_st.FilterIdLow = 0x0000;
    can_filter_st.FilterMaskIdHigh = 0x0000;
    can_filter_st.FilterMaskIdLow = 0x0000;
    can_filter_st.FilterBank = 0;
    can_filter_st.FilterFIFOAssignment = CAN_RX_FIFO0;
    HAL_CAN_ConfigFilter(&hcan1, &can_filter_st);
    HAL_CAN_Start(&hcan1);
    HAL_CAN_ActivateNotification(&hcan1, CAN_IT_RX_FIFO0_MSG_PENDING);
    can_filter_st.SlaveStartFilterBank = 14;
    can_filter_st.FilterBank = 14;
    HAL_CAN_ConfigFilter(&hcan2, &can_filter_st);
    HAL_CAN_Start(&hcan2);
    HAL_CAN_ActivateNotification(&hcan2, CAN_IT_RX_FIFO0_MSG_PENDING);
}//过滤

uint8_t rx_data[8];
uint16_t aim_current=0;
uint32_t send_mail_box2;
CAN_TxHeaderTypeDef Txheader2;
Txheader2.StdId = 0x200;
Txheader2.IDE = CAN_ID_STD;
Txheader2.DLC = 0x08;
Txheader2.RTR =CAN_RTR_DATA;
uint8_t can_send_data2[8];
can_send_data2[0]=aim_current>>8;
can_send_data2[1]=aim_current;
HAL_CAN_AddTxMessage(&hcan1,&Txheader2,can_send_data2,&send_mail_box2);//发送

struct motor_measure
{
uint16_t ecd=0;
uint16_t motor_speed=0;
uint16_t real_current=0;
uint16_t temperature=0;
}motor1;
void HAL_CAN_RxFifo0MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
	CAN_RxHeaderTypeDef rx_header;
	HAL_CAN_GetRxMessage(hcan,CAN_RX_FIFO0,&rx_header,rx_data);
	if(hcan==&hcan1)
	{
	 if(rx_header.StdId==0x201)
	 {
        motor1.ecd=rx_data[0]<<8|rx_data[1];
		motor1.motor_speed=rx_data[2]<<8|rx_data[3];
        motor1.real_current=rx_data[4]<<8|rx_data[5];
        motor1.temperature=rx_data[6];
	 }
	}
}//接收

```

## <font color=Green>七、拓展</font>

### <font color=Green>1、搭建3D一阶倒立摆模型，并进行闭环控制</font>

<font color=Blue>使用matlab或者Webots软件，附上重要设计公式、设计过程截图、代码和结果，并进行分析</font>

### <font color=Green>2、搭建3D倒立摆轮腿模型，并进行闭环控制</font>

<font color=Blue>使用matlab或者Webots软件，附上重要设计公式、重要设计过程截图、代码和结果，并进行分析</font>

### <font color=Green>3、搭建3D四轮小车模型，并进行闭环控制</font>

<font color=Blue>使用matlab或者Webots软件，附上重要设计公式、重要设计过程截图、代码和结果，并进行分析</font>
